<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TD1 — Exo 3 Leaflet+</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body{font-family:system-ui,Arial,sans-serif;max-width:1100px;margin:24px auto;padding:0 16px}
    #map{height:540px;margin:12px 0;border-radius:8px;overflow:hidden}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    .box{background:#f6f6f6;border-radius:8px;padding:8px 12px}
    .ok{color:green}.err{color:#b00020}
  </style>
</head>
<body>
<h1>Exo 3 — Leaflet avancé</h1>
<div class="row">
  <span id="status" class="box">Initialisation…</span>
  <span id="dist" class="box">Distance Marseille : —</span>
</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
// Points fixes
const NICE = [43.7000, 7.2700];
const MARSEILLE = [43.2965, 5.3698];

// Couches de tuiles (OSM + Stamen Toner Lite ; au besoin, bascule sur OSM si Stamen indispo)
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  maxZoom: 19, attribution: '&copy; OpenStreetMap contributors'
});
const stamen = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png',{
  maxZoom: 20, attribution: 'Map tiles by Stamen Design — Data © OpenStreetMap'
});

const map = L.map('map', {center: NICE, zoom: 12, layers: [osm]});
const baseMaps = { "OpenStreetMap": osm, "Stamen Toner Lite": stamen };
L.control.layers(baseMaps, null, {collapsed:true}).addTo(map);

// Marqueur Marseille
const m_mrs = L.marker(MARSEILLE).addTo(map).bindPopup('Marseille');

// Utilitaire distance (m) → km
const km = (m)=> (m/1000).toFixed(2);

// Calcule distance affichée
function showDistance(fromLatLng){
  const d = L.latLng(fromLatLng).distanceTo(L.latLng(MARSEILLE));
  document.getElementById('dist').textContent = `Distance Marseille : ${km(d)} km`;
}

function setStatus(msg, ok=true){ const el=document.getElementById('status'); el.className = ok?'box ok':'box err'; el.textContent=msg; }

if (!navigator.geolocation){
  setStatus('Géolocalisation non supportée', false);
} else {
  navigator.geolocation.getCurrentPosition((pos)=>{
    const {latitude, longitude, accuracy} = pos.coords;
    const me = [latitude, longitude];

    map.setView(me, 13);
    const meMarker = L.marker(me).addTo(map).bindPopup('Moi').openPopup();

    // Cercle de précision (taille = accuracy)
    L.circle(me, {radius: accuracy, color:'#3388ff', fillOpacity:0.1}).addTo(map)
      .bindPopup(`Précision ≈ ${Math.round(accuracy)} m`);

    // Segment Nice<->Marseille (le TD demande Marseille ↔ "notre position")
    const seg = L.polyline([me, MARSEILLE], {color:'#f03'}).addTo(map)
      .bindPopup('Segment moi ↔ Marseille');

    // Distance
    showDistance(me);
    setStatus('OK — fond de carte + précision + distance + segment');

    // Optionnel : surveiller déplacement (watchPosition) pour MAJ distance en temps réel
    // navigator.geolocation.watchPosition(p=>showDistance([p.coords.latitude, p.coords.longitude]));

  }, (err)=>{
    setStatus(`Erreur géoloc: ${err.message}`, false);
  }, {enableHighAccuracy:true, maximumAge:0, timeout:10000});
}

// ===== Chargement de GeoJSON via API gouvernementale (exemple du cours) =====
// Exemple: Communes par code postal, géométrie = centre
// URL type (Ex. 06330, comme sur la slide): la réponse contient la géométrie (centre)
fetch('https://geo.api.gouv.fr/communes?codePostal=06330&fields=nom,code,codesPostaux,codeDepartement,codeRegion,population&format=geojson&geometry=centre')
  .then(r=>r.json())
  .then(geojson=>{
    const layer = L.geoJSON(geojson, {
      pointToLayer: (feat, latlng)=> L.circleMarker(latlng, {radius:6, weight:2})
        .bindPopup(`${feat.properties.nom} (${feat.properties.code})`)
    }).addTo(map);
  })
  .catch(e=>console.warn('GeoJSON API error', e));

// ===== Bonus itinéraire (MapQuest/Mapbox) =====
// Placeholders : renseigne ton token depuis le TD si tu veux tester une route.
// MapQuest token (fourni dans le TD): tR2C6osuQcc3RoWnxDMXF6FACtNAzMl8
// Mapbox token (fourni dans le TD): pk.eyJ1IjoiY3YwNiIsImEiOiJjajg2MmpzYjcwbWdnMzNsc2NzM2l4eW0yIn0.TfDJipR5II7orUZaC848YA
// Astuce : commence par tracer une polyline de points GPS “faits maison”, puis passe à l’API Directions.
</script>
</body>
</html>
